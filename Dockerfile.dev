# syntax=docker/dockerfile:1

ARG RUBY_VERSION=3.3.0
FROM ruby:${RUBY_VERSION}-slim

WORKDIR /app

# Install system deps for building gems
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y build-essential libpq-dev libvips git curl && \
    rm -rf /var/lib/apt/lists/* /var/cache/apt/archives

# Install bundler
RUN gem install bundler

# Cache Gemfile gems
COPY Gemfile Gemfile.lock ./
RUN bundle config set path '/usr/local/bundle' && bundle install --jobs 4 --retry 3

# Copy app for runtime (overridden by volume in compose)
COPY . .

# Ensure entrypoint is executable
RUN chmod +x ./docker-entrypoint.sh || true

ENV RAILS_ENV=development
EXPOSE 3000

CMD ["bash", "-c", "bundle exec rails server -b 0.0.0.0 -p 3000"]
